-- Load required services and libraries
local VirtualUser = game:GetService("VirtualUser")
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer

-- Anti AFK Script
Players.LocalPlayer.Idled:Connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
    print("Anti AFK: Prevented kick due to inactivity.")
end)

-- Load external libraries
local Library = loadstring(Game:HttpGet("https://raw.githubusercontent.com/bloodball/-back-ups-for-libs/main/wizard"))()

-- Utility Functions
local function fireRemoteEvent(remoteEvent, ...)
    ReplicatedStorage.Assets.RemoteEvents[remoteEvent]:FireServer(...)
end

local function spendColor(color, amount, times)
    local args = { color, amount }
    for _ = 1, times do
        fireRemoteEvent("SpendColor", unpack(args))
        task.wait(0.5)
    end
end

-- Collect Function
local function Collect()
    while _G.Auto_Collect do
        for _, Drop in pairs(game:GetService("Workspace").Pixels:GetChildren()) do
            if Drop:IsA("BasePart") then
                Drop.CFrame = LocalPlayer.Character.HumanoidRootPart.CFrame
            end
        end
        task.wait(0.1)
    end
end

-- Click Function
local function Click()
    while _G.Auto_Click do
        fireRemoteEvent("Click")
        task.wait(0.1)
    end
end

-- Color Function
local function Color()
    spendColor("Purple", 10, 4)
    spendColor("Blue", 10, 6)
    spendColor("Blue", 1, 6)
    fireRemoteEvent("SpendColor", "Green", 100)
end

-- General Buy Function
local function Buy(upgradeList, interval)
    while _G[upgradeList.autoFlag] do
        for _, upgrade in ipairs(upgradeList.upgrades) do
            fireRemoteEvent("BuyUpgrade", unpack(upgrade))
            task.wait(interval)
        end
    end
end

-- Buy Lists
local buyLists = {
    Auto_Buy_Prestige = {
        autoFlag = "Auto_Buy_Prestige",
        upgrades = {
            {"4_3", true},
            {"4_1", true},
            {"4_2", true},
            {"4_4", true}
        },
        interval = 2
    },
    Auto_Buy_Click = {
        autoFlag = "Auto_Buy_Click",
        upgrades = {
            {"5_1", true},
            {"5_2", true},
            {"5_3", true}
        },
        interval = 2
    },
    Auto_Buy_RNG = {
        autoFlag = "Auto_Buy_RNG",
        upgrades = {
            {"3_3", true},
            {"3_4", true},
            {"3_1", true},
            {"3_2", true}
        },
        interval = 10
    },
    Auto_Buy_Gems = {
        autoFlag = "Auto_Buy_Gems",
        upgrades = {
            {"8_1", true},
            {"8_3", true},
            {"8_2", true},
            {"8_4", true}
        },
        interval = 10
    },
    Auto_Buy_Research = {
        autoFlag = "Auto_Buy_Research",
        upgrades = {
            {"7_3", true},
            {"7_1", true},
            {"7_6", true},
            {"7_4", true},
            {"7_8", true},
            {"7_11", true},
            {"7_16", true},
            {"7_17", true},
            {"7_12", true},
            {"7_13", true},
            {"7_19", true},
            {"7_21", true},
            {"7_24", true}
        },
        interval = 1
    }
}

-- Farm Function
local function Farm()
    local humanoidRootPart = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    local humanoid = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid")

    if not humanoidRootPart or not humanoid then return end

    while _G.Auto_Farm do
        humanoidRootPart.CFrame = CFrame.new(game:GetService("Workspace").Research.Button.Touch.CFrame.Position + Vector3.new(0, 1, 0))
        humanoid:ChangeState(Enum.HumanoidStateType.GettingUp)
        task.wait(1)
        humanoidRootPart.CFrame = CFrame.new(game:GetService("Workspace").Runes.Button.Touch.CFrame.Position + Vector3.new(0, 1, 0))
        humanoid:ChangeState(Enum.HumanoidStateType.GettingUp)
        task.wait(59)
    end
end

-- UI Setup
local ui = Library:NewWindow("Pixel Incremental 2")
local a = ui:NewSection("Farm")
local b = ui:NewSection("Buy")

a:CreateToggle("Auto Farm", function(value)
    _G.Auto_Farm = value
    if value then
        Farm()
    end
end)

a:CreateToggle("Auto Collect", function(value)
    _G.Auto_Collect = value
    if value then
        Collect()
    end
end)

a:CreateToggle("Auto Click", function(value)
    _G.Auto_Click = value
    if value then
        Click()
    end
end)

a:CreateButton("Spend Color equally", function(value)
    Color()
end)

local order = {
    "Auto_Buy_Prestige",
    "Auto_Buy_Click",
    "Auto_Buy_RNG",
    "Auto_Buy_Gems",
    "Auto_Buy_Research"
}

for _, key in ipairs(order) do
    local upgradeList = buyLists[key]
    if upgradeList then
        b:CreateToggle(key:gsub("_", " "), function(value)
            _G[key] = value
            if value then
                Buy(upgradeList, upgradeList.interval)
            end
        end)
    end
end
